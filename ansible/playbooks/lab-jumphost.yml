---
- name: Configure OCI Labs jumphost / gateway
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  # Sicherstellen, dass wir sinnvolle Defaults haben, falls jemand das Playbook
  # ohne extra-vars direkt lokal aufruft.
  vars:
    ssh_port: "{{ ssh_port | default(22) }}"
    enable_wireguard: "{{ enable_wireguard | default(true) }}"
    lab_name: "{{ lab_name | default('lab-unknown') }}"

  roles:
    - role: common
      tags: [common, base]

    - role: common_hardening
      tags: [hardening, security]

    - role: jumphost_base
      tags: [jumphost, base]

    - role: base_ssh
      vars:
        ssh_port: "{{ ssh_port }}"
        ssh_password_auth: false
      tags: [ssh, security]

    - role: firewall
      vars:
        firewall_ssh_port: "{{ ssh_port }}"
        firewall_wireguard_port: 51820
        firewall_enable_wireguard: "{{ enable_wireguard }}"
      tags: [firewall, network, security]

    - role: fail2ban
      tags: [fail2ban, security]

    - role: wireguard_gateway
      vars:
        wireguard_port: 51820
        enable_wireguard: "{{ enable_wireguard }}"
      tags: [wireguard, vpn, gateway]
